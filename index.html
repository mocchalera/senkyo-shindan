<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>あなたの一票、どこへ？ | 衆議院選挙2026 投票先診断</title>
  <style>
    :root {
      --bg: #0f172a;
      --bg-soft: #18233f;
      --card: #121e38;
      --card-strong: #1a2a4d;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --line: rgba(148, 163, 184, 0.26);
      --accent-a: #3b82f6;
      --accent-b: #8b5cf6;
      --accent-c: #60a5fa;
      --ok: #22c55e;
      --warn: #f59e0b;
      --danger: #f43f5e;
      --shadow: 0 18px 40px rgba(7, 10, 20, 0.45);
      --radius-lg: 20px;
      --radius-md: 14px;
      --radius-sm: 10px;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      font-family: system-ui, "Hiragino Sans", sans-serif;
      color: var(--text);
      background:
        radial-gradient(circle at 10% 12%, rgba(59, 130, 246, 0.22), transparent 26%),
        radial-gradient(circle at 88% 6%, rgba(139, 92, 246, 0.24), transparent 30%),
        linear-gradient(160deg, #0f172a 12%, #101f3d 52%, #0f172a 100%);
      background-attachment: fixed;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    .app-shell {
      max-width: 1080px;
      margin: 0 auto;
      min-height: 100%;
      padding: 24px 16px 36px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      position: relative;
      z-index: 2;
    }

    .brand-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      border: 1px solid var(--line);
      border-radius: var(--radius-md);
      background: rgba(11, 18, 36, 0.64);
      backdrop-filter: blur(8px);
    }

    .brand-tag {
      margin: 0;
      font-size: 0.84rem;
      color: #bfdbfe;
      letter-spacing: 0.02em;
      font-weight: 700;
    }

    .brand-date {
      margin: 0;
      font-size: 0.84rem;
      color: var(--muted);
      font-weight: 600;
      text-align: right;
    }

    .screen {
      display: none;
      animation: fade-in 360ms ease;
    }

    .screen.active {
      display: block;
    }

    .panel {
      border-radius: var(--radius-lg);
      border: 1px solid var(--line);
      background: linear-gradient(165deg, rgba(18, 30, 56, 0.94), rgba(13, 22, 42, 0.94));
      box-shadow: var(--shadow);
      padding: 22px 18px;
    }

    .welcome-title {
      margin: 0 0 8px;
      font-size: clamp(1.75rem, 4.4vw, 2.8rem);
      line-height: 1.2;
      font-weight: 800;
      letter-spacing: -0.01em;
      background: linear-gradient(90deg, #dbeafe 0%, #bfdbfe 40%, #c4b5fd 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .welcome-subtitle {
      margin: 0;
      font-size: 1rem;
      color: #dbeafe;
      font-weight: 600;
    }

    .welcome-election {
      margin: 10px 0 16px;
      font-size: 0.94rem;
      color: #93c5fd;
      font-weight: 600;
    }

    .notice {
      margin: 0;
      border: 1px solid rgba(96, 165, 250, 0.35);
      border-radius: var(--radius-md);
      padding: 12px 14px;
      color: #bfdbfe;
      background: rgba(37, 99, 235, 0.14);
      font-size: 0.9rem;
    }

    .warmup-box {
      margin-top: 18px;
      padding: 14px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(99, 102, 241, 0.34);
      background: rgba(56, 189, 248, 0.09);
    }

    .warmup-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .warmup-label {
      margin: 0;
      font-size: 0.85rem;
      color: #cbd5e1;
      font-weight: 600;
    }

    .warmup-track {
      height: 9px;
      width: 100%;
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid rgba(147, 197, 253, 0.28);
      background: rgba(30, 41, 59, 0.9);
    }

    .warmup-fill {
      width: 32%;
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, var(--accent-a), var(--accent-b), var(--accent-c));
      animation: warmup-fill 2.6s ease-in-out infinite;
      box-shadow: 0 0 22px rgba(59, 130, 246, 0.6);
    }

    .issue-tags {
      margin-top: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .issue-tag {
      font-size: 0.78rem;
      color: #cbd5e1;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(51, 65, 85, 0.46);
      padding: 5px 10px;
      border-radius: 999px;
    }

    .btn {
      appearance: none;
      border: none;
      border-radius: 14px;
      font-size: 0.98rem;
      font-weight: 700;
      line-height: 1.2;
      cursor: pointer;
      transition: transform 160ms ease, box-shadow 160ms ease, filter 160ms ease;
      min-height: 46px;
      padding: 11px 18px;
    }

    .btn:focus-visible {
      outline: 3px solid rgba(96, 165, 250, 0.92);
      outline-offset: 2px;
    }

    .btn-primary {
      margin-top: 20px;
      width: min(100%, 360px);
      color: #f8fafc;
      background: linear-gradient(95deg, var(--accent-a), var(--accent-b));
      box-shadow: 0 14px 26px rgba(37, 99, 235, 0.35);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      filter: brightness(1.08);
    }

    .btn-secondary {
      background: #1e293b;
      color: #e2e8f0;
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .quiz-head {
      display: grid;
      gap: 8px;
      margin-bottom: 14px;
    }

    .quiz-progress {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: #bfdbfe;
      font-weight: 600;
    }

    .track {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.32);
      overflow: hidden;
      background: rgba(30, 41, 59, 0.75);
    }

    .fill {
      width: 0%;
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, #22d3ee, #3b82f6, #8b5cf6);
      transition: width 320ms ease;
      box-shadow: 0 0 18px rgba(56, 189, 248, 0.48);
    }

    .question-card {
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: linear-gradient(160deg, rgba(15, 23, 42, 0.9), rgba(19, 30, 56, 0.9));
      padding: 18px 16px;
      min-height: 366px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .question-card.slide-in {
      animation: slide-in 280ms ease;
    }

    .question-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .question-title {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 800;
      line-height: 1.45;
      color: #eff6ff;
    }

    .question-badge {
      margin: 0;
      font-size: 0.76rem;
      color: #dbeafe;
      border: 1px solid rgba(147, 197, 253, 0.45);
      border-radius: 999px;
      padding: 4px 10px;
      font-weight: 700;
      background: rgba(37, 99, 235, 0.22);
    }

    .question-hint {
      margin: 0;
      color: var(--muted);
      font-size: 0.88rem;
      line-height: 1.5;
    }

    .option-list {
      display: grid;
      gap: 10px;
    }

    .option-btn {
      text-align: left;
      width: 100%;
      border: 1px solid rgba(148, 163, 184, 0.36);
      color: #e2e8f0;
      background: linear-gradient(180deg, rgba(51, 65, 85, 0.4), rgba(30, 41, 59, 0.72));
      border-radius: var(--radius-sm);
      padding: 12px 12px;
      min-height: 54px;
      display: flex;
      gap: 10px;
      align-items: flex-start;
      cursor: pointer;
      transition: border-color 160ms ease, transform 160ms ease, background 160ms ease;
      font-size: 0.94rem;
      line-height: 1.5;
    }

    .option-btn:hover {
      border-color: rgba(147, 197, 253, 0.8);
      transform: translateY(-1px);
      background: linear-gradient(180deg, rgba(37, 99, 235, 0.36), rgba(30, 41, 59, 0.82));
    }

    .option-btn[disabled] {
      opacity: 0.55;
      cursor: not-allowed;
      transform: none;
    }

    .option-key {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex: 0 0 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.9);
      font-size: 0.78rem;
      font-weight: 800;
      color: #cbd5e1;
      margin-top: 1px;
    }

    .reaction {
      min-height: 28px;
      margin: 10px 2px 0;
      font-size: 0.93rem;
      color: #a7f3d0;
      opacity: 0;
      transform: translateY(4px);
      transition: opacity 220ms ease, transform 220ms ease;
      font-weight: 700;
    }

    .reaction.show {
      opacity: 1;
      transform: translateY(0);
    }

    .result-header {
      margin: 0 0 12px;
    }

    .result-title {
      margin: 0;
      font-size: clamp(1.3rem, 4.8vw, 2rem);
      font-weight: 800;
      letter-spacing: -0.01em;
      color: #f8fafc;
    }

    .result-subtitle {
      margin: 6px 0 0;
      color: #cbd5e1;
      font-size: 0.93rem;
    }

    .tab-row {
      margin-top: 14px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .tab-btn {
      border: 1px solid rgba(148, 163, 184, 0.36);
      background: rgba(30, 41, 59, 0.8);
      color: #cbd5e1;
      border-radius: 999px;
      padding: 8px 14px;
      font-weight: 700;
      cursor: pointer;
      transition: border-color 160ms ease, background 160ms ease, color 160ms ease;
    }

    .tab-btn.active {
      border-color: rgba(99, 102, 241, 0.75);
      background: linear-gradient(90deg, rgba(59, 130, 246, 0.4), rgba(139, 92, 246, 0.44));
      color: #f8fafc;
    }

    .tab-panel {
      display: none;
      margin-top: 16px;
    }

    .tab-panel.active {
      display: block;
      animation: fade-in 280ms ease;
    }

    .top3 {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .party-card {
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(15, 23, 42, 0.86);
      padding: 14px 12px;
      position: relative;
      overflow: hidden;
    }

    .party-card::before {
      content: "";
      position: absolute;
      inset: 0;
      opacity: 0.15;
      pointer-events: none;
      background: linear-gradient(120deg, transparent, rgba(255, 255, 255, 0.24), transparent 80%);
    }

    .party-card.rank-1 {
      border-color: rgba(250, 204, 21, 0.78);
      background: linear-gradient(160deg, rgba(57, 44, 9, 0.7), rgba(15, 23, 42, 0.96));
      box-shadow: 0 16px 34px rgba(250, 204, 21, 0.16);
    }

    .party-rank {
      margin: 0;
      font-size: 0.78rem;
      color: #cbd5e1;
      font-weight: 700;
    }

    .party-name {
      margin: 6px 0 0;
      font-size: 1.2rem;
      font-weight: 800;
      color: #f8fafc;
      line-height: 1.3;
    }

    .party-score {
      margin: 8px 0 0;
      font-size: 1.5rem;
      font-weight: 800;
      color: #dbeafe;
      letter-spacing: 0.01em;
    }

    .party-score small {
      font-size: 0.82rem;
      color: #cbd5e1;
      font-weight: 600;
      margin-left: 8px;
    }

    .section-title {
      margin: 18px 0 8px;
      font-size: 1rem;
      color: #e2e8f0;
      font-weight: 800;
    }

    .bars {
      display: grid;
      gap: 9px;
    }

    .bar-row {
      display: grid;
      grid-template-columns: 90px 1fr 56px;
      align-items: center;
      gap: 8px;
      font-size: 0.82rem;
      color: #cbd5e1;
    }

    .bar-track {
      width: 100%;
      height: 12px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(30, 41, 59, 0.8);
      overflow: hidden;
    }

    .bar-fill {
      width: 0%;
      height: 100%;
      border-radius: inherit;
      transition: width 900ms cubic-bezier(.2,.9,.25,1);
    }

    .bar-value {
      text-align: right;
      font-weight: 700;
      color: #e2e8f0;
      font-variant-numeric: tabular-nums;
    }

    .quick-learning {
      margin-top: 16px;
      border: 1px solid rgba(125, 211, 252, 0.28);
      border-radius: var(--radius-md);
      padding: 12px;
      background: rgba(14, 116, 144, 0.13);
    }

    .quick-learning p {
      margin: 0;
      font-size: 0.88rem;
      color: #bae6fd;
    }

    .party-grid {
      margin-top: 14px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .party-detail {
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(15, 23, 42, 0.88);
      padding: 11px;
    }

    .party-detail h4 {
      margin: 0;
      font-size: 0.98rem;
      color: #f1f5f9;
      line-height: 1.35;
    }

    .party-detail p {
      margin: 7px 0 0;
      font-size: 0.82rem;
      color: #cbd5e1;
      line-height: 1.55;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .chip {
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 0.74rem;
      color: #dbeafe;
      background: rgba(37, 99, 235, 0.2);
    }

    .actions {
      margin-top: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      flex-direction: column;
      align-items: stretch;
    }

    .prefecture-grid {
      margin-top: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 10px;
    }

    .prefecture-btn {
      padding: 14px 12px;
      border: 1px solid rgba(148, 163, 184, 0.36);
      background: linear-gradient(180deg, rgba(51, 65, 85, 0.4), rgba(30, 41, 59, 0.72));
      color: #e2e8f0;
      border-radius: var(--radius-sm);
      font-weight: 700;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 160ms ease;
    }

    .prefecture-btn:hover {
      border-color: rgba(147, 197, 253, 0.8);
      transform: translateY(-1px);
      background: linear-gradient(180deg, rgba(37, 99, 235, 0.36), rgba(30, 41, 59, 0.82));
    }

    .district-grid {
      margin-top: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 8px;
    }

    .district-btn {
      padding: 12px 10px;
      border: 1px solid rgba(148, 163, 184, 0.36);
      background: linear-gradient(180deg, rgba(51, 65, 85, 0.4), rgba(30, 41, 59, 0.72));
      color: #e2e8f0;
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-size: 0.88rem;
      cursor: pointer;
      transition: all 160ms ease;
    }

    .district-btn:hover {
      border-color: rgba(147, 197, 253, 0.8);
      transform: translateY(-1px);
      background: linear-gradient(180deg, rgba(37, 99, 235, 0.36), rgba(30, 41, 59, 0.82));
    }

    .candidate-card {
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(15, 23, 42, 0.88);
      padding: 12px;
      margin-bottom: 10px;
      border-left: 4px solid;
    }

    .candidate-card h5 {
      margin: 0;
      font-size: 1rem;
      color: #f1f5f9;
      line-height: 1.35;
    }

    .candidate-card p {
      margin: 5px 0 0;
      font-size: 0.85rem;
      color: #cbd5e1;
    }

    .candidate-badge {
      display: inline-block;
      background: rgba(34, 197, 94, 0.2);
      border: 1px solid rgba(34, 197, 94, 0.5);
      color: #86efac;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.72rem;
      font-weight: 700;
      margin-left: 8px;
    }

    .back-btn {
      margin-bottom: 16px;
      background: rgba(30, 41, 59, 0.8);
      color: #cbd5e1;
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 8px 14px;
      border-radius: 999px;
      font-weight: 700;
      cursor: pointer;
      transition: all 160ms ease;
    }

    .back-btn:hover {
      background: rgba(51, 65, 85, 0.9);
      border-color: rgba(148, 163, 184, 0.5);
    }

    .region-section {
      margin-bottom: 24px;
    }

    .region-title {
      margin: 0 0 12px;
      font-size: 0.9rem;
      color: #94a3b8;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .learn-block {
      display: grid;
      gap: 12px;
    }

    .learn-card {
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.3);
      padding: 12px;
      background: rgba(15, 23, 42, 0.88);
    }

    .learn-card h4 {
      margin: 0;
      font-size: 0.98rem;
      color: #f1f5f9;
      line-height: 1.38;
    }

    .learn-card p {
      margin: 7px 0 0;
      font-size: 0.85rem;
      color: #cbd5e1;
      line-height: 1.56;
    }

    .learn-answer {
      margin-top: 8px;
      font-size: 0.82rem;
      color: #bfdbfe;
      font-weight: 700;
      line-height: 1.5;
    }

    details {
      margin-top: 8px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(30, 41, 59, 0.6);
      padding: 8px 10px;
    }

    summary {
      cursor: pointer;
      color: #e2e8f0;
      font-size: 0.82rem;
      font-weight: 700;
    }

    .stance-list {
      margin: 8px 0 0;
      padding: 0;
      list-style: none;
      display: grid;
      gap: 6px;
      font-size: 0.79rem;
      color: #cbd5e1;
    }

    .stance-item {
      border: 1px solid rgba(148, 163, 184, 0.23);
      border-radius: 8px;
      padding: 6px 8px;
      background: rgba(15, 23, 42, 0.72);
      line-height: 1.5;
    }

    .position-map-wrap {
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.34);
      padding: 12px;
      background: rgba(15, 23, 42, 0.92);
    }

    .position-map {
      position: relative;
      height: 330px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.24);
      background:
        linear-gradient(to right, rgba(59, 130, 246, 0.08), transparent 48%, rgba(244, 63, 94, 0.08)),
        linear-gradient(to bottom, rgba(251, 191, 36, 0.08), transparent 48%, rgba(56, 189, 248, 0.08)),
        rgba(15, 23, 42, 0.8);
      overflow: hidden;
    }

    .axis-h,
    .axis-v {
      position: absolute;
      background: rgba(148, 163, 184, 0.42);
    }

    .axis-h {
      left: 0;
      right: 0;
      top: 50%;
      height: 1px;
    }

    .axis-v {
      top: 0;
      bottom: 0;
      left: 50%;
      width: 1px;
    }

    .axis-label {
      position: absolute;
      font-size: 0.72rem;
      color: #cbd5e1;
      font-weight: 700;
      background: rgba(15, 23, 42, 0.74);
      border: 1px solid rgba(148, 163, 184, 0.28);
      border-radius: 6px;
      padding: 2px 6px;
      white-space: nowrap;
    }

    .dot {
      position: absolute;
      transform: translate(-50%, -50%);
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.7);
      box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.75);
    }

    .dot-label {
      position: absolute;
      transform: translate(-50%, calc(-50% - 16px));
      font-size: 0.71rem;
      color: #f1f5f9;
      font-weight: 700;
      text-shadow: 0 2px 6px rgba(2, 6, 23, 0.75);
      pointer-events: none;
      white-space: nowrap;
    }

    .manifest-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .manifest-card {
      border: 1px solid rgba(148, 163, 184, 0.3);
      border-radius: var(--radius-md);
      padding: 11px;
      background: rgba(15, 23, 42, 0.88);
    }

    .manifest-card h5 {
      margin: 0;
      font-size: 0.93rem;
      color: #f8fafc;
      line-height: 1.35;
    }

    .manifest-card ul {
      margin: 8px 0 0;
      padding-left: 1.1rem;
      color: #cbd5e1;
      font-size: 0.8rem;
      line-height: 1.55;
    }

    .disclaimer {
      margin-top: 14px;
      border: 1px solid rgba(148, 163, 184, 0.34);
      border-radius: var(--radius-md);
      background: rgba(30, 41, 59, 0.58);
      padding: 10px 12px;
      font-size: 0.82rem;
      color: #cbd5e1;
      line-height: 1.58;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    #confetti {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 8;
    }

    @media (min-width: 760px) {
      .app-shell {
        padding: 28px 22px 46px;
      }

      .panel {
        padding: 26px 24px;
      }

      .top3 {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }

      .party-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .manifest-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (min-width: 1020px) {
      .party-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }

      .manifest-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation: none !important;
        transition: none !important;
      }
    }

    @keyframes warmup-fill {
      0% { width: 12%; }
      50% { width: 88%; }
      100% { width: 12%; }
    }

    @keyframes fade-in {
      from {
        opacity: 0;
        transform: translateY(6px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slide-in {
      from {
        opacity: 0;
        transform: translateX(12px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
  </style>
</head>
<body>
  <canvas id="confetti" aria-hidden="true"></canvas>
  <div class="app-shell">
    <header class="brand-bar">
      <p class="brand-tag">衆議院選挙2026 投票先診断</p>
      <p class="brand-date">投開票: 2026年2月8日（日）</p>
    </header>

    <main>
      <section id="welcomeScreen" class="screen active panel" aria-labelledby="welcomeTitle">
        <h1 id="welcomeTitle" class="welcome-title">あなたの一票、どこへ？</h1>
        <p class="welcome-subtitle">10の質問であなたの政策スタンスを診断</p>
        <p class="welcome-election">第51回衆議院議員総選挙 | 2026年2月8日（日）投開票</p>
        <p class="notice">この診断は政策の一致度を参考として表示するものです。実際の投票は総合的にご判断ください。</p>

        <div class="warmup-box" aria-hidden="true">
          <div class="warmup-row">
            <p class="warmup-label">診断ロード中</p>
            <p class="warmup-label">10問チャレンジ</p>
          </div>
          <div class="warmup-track">
            <div class="warmup-fill"></div>
          </div>
          <div class="issue-tags">
            <span class="issue-tag">消費税</span>
            <span class="issue-tag">原発・エネルギー</span>
            <span class="issue-tag">安全保障</span>
            <span class="issue-tag">社会保障</span>
            <span class="issue-tag">政治改革</span>
          </div>
        </div>

        <div class="actions">
          <button id="selectConstituencyButton" class="btn btn-primary">選挙区を選んで診断する</button>
          <button id="startButton" class="btn btn-secondary">選挙区を選ばずに始める</button>
        </div>
      </section>

      <section id="constituencyScreen" class="screen panel" aria-labelledby="constituencyTitle">
        <h2 id="constituencyTitle" class="welcome-title">選挙区を選択</h2>
        <p class="welcome-subtitle">お住まいの都道府県と選挙区を選んでください</p>

        <div id="constituencyContent"></div>
      </section>

      <section id="quizScreen" class="screen panel" aria-live="polite">
        <div class="quiz-head">
          <div class="quiz-progress">
            <span id="progressText">10問中 1問目</span>
            <span id="progressPercent">10%</span>
          </div>
          <div class="track" aria-hidden="true">
            <div id="progressFill" class="fill"></div>
          </div>
        </div>
        <div id="questionCard" class="question-card"></div>
        <p id="reactionText" class="reaction" role="status" aria-live="polite"></p>
      </section>

      <section id="resultScreen" class="screen panel" aria-live="polite">
        <header class="result-header">
          <h2 class="result-title">診断結果</h2>
          <p class="result-subtitle">政策の一致度を可視化した参考結果です。実際の投票は候補者情報や地域事情も含めてご判断ください。</p>
        </header>

        <div class="tab-row" role="tablist" aria-label="結果タブ">
          <button class="tab-btn active" data-tab="summary" role="tab" aria-selected="true">結果サマリー</button>
          <button class="tab-btn" data-tab="learn" role="tab" aria-selected="false">学びモード</button>
        </div>

        <section id="summaryTab" class="tab-panel active" role="tabpanel"></section>
        <section id="learnTab" class="tab-panel" role="tabpanel"></section>
      </section>
    </main>
  </div>

  <script>
    (() => {
      // Will be populated dynamically
      let districtData = null;
      let selectedConstituency = null;

      const prefectureToBlock = {
        "北海道": "北海道",
        "青森県": "東北", "岩手県": "東北", "宮城県": "東北", "秋田県": "東北", "山形県": "東北", "福島県": "東北",
        "新潟県": "北陸信越", "富山県": "北陸信越", "石川県": "北陸信越", "福井県": "北陸信越", "長野県": "北陸信越",
        "茨城県": "北関東", "栃木県": "北関東", "群馬県": "北関東", "埼玉県": "北関東",
        "千葉県": "南関東", "神奈川県": "南関東", "山梨県": "南関東",
        "東京都": "東京",
        "岐阜県": "東海", "静岡県": "東海", "愛知県": "東海", "三重県": "東海",
        "滋賀県": "近畿", "京都府": "近畿", "大阪府": "近畿", "兵庫県": "近畿", "奈良県": "近畿", "和歌山県": "近畿",
        "鳥取県": "中国", "島根県": "中国", "岡山県": "中国", "広島県": "中国", "山口県": "中国",
        "徳島県": "四国", "香川県": "四国", "愛媛県": "四国", "高知県": "四国",
        "福岡県": "九州", "佐賀県": "九州", "長崎県": "九州", "熊本県": "九州", "大分県": "九州", "宮崎県": "九州", "鹿児島県": "九州", "沖縄県": "九州"
      };

      const parties = [
        {
          id: "ldp",
          name: "自由民主党",
          short: "自民党",
          color: "#e43f3f",
          description: "与党。成長投資と安全保障強化を軸に、制度の持続可能性を重視する方針です。",
          highlights: [
            "飲食料品の消費税0%を検討加速",
            "原発再稼働・活用推進",
            "安保3文書改定と防衛装備品輸出拡大",
            "自衛隊明記の憲法改正を推進"
          ],
          position: { economic: -55, social: 68 }
        },
        {
          id: "ishin",
          name: "日本維新の会",
          short: "維新",
          color: "#00b050",
          description: "与党連立パートナー。規制改革と負担軽減を通じた成長戦略を重視する方針です。",
          highlights: [
            "社会保険料引き下げを優先",
            "条件付きで原発再稼働を容認",
            "安保3文書の前倒し改定と核共有議論",
            "副首都構想と規制改革を推進"
          ],
          position: { economic: -48, social: 50 }
        },
        {
          id: "reform",
          name: "中道改革連合",
          short: "中道改革連合",
          color: "#ff8c00",
          description: "立憲民主党と公明党が合流した新党。生活者ファーストと中道的調整を掲げます。",
          highlights: [
            "食料品消費税ゼロ（今秋から）",
            "安全確認された原発の再稼働と依存低減",
            "防衛装備移転に慎重姿勢、非核三原則堅持",
            "教育無償化拡大と若者向け家賃補助"
          ],
          position: { economic: -6, social: -4 }
        },
        {
          id: "dpfp",
          name: "国民民主党",
          short: "国民民主党",
          color: "#ffd700",
          description: "減税と社会保険料軽減で手取りを増やす、現実路線の中道政策を打ち出しています。",
          highlights: [
            "減税と社会保険料軽減で手取り増",
            "日米安保基軸で抑止力を強化",
            "憲法改正議論には参加",
            "現役世代の負担軽減を重視"
          ],
          position: { economic: -24, social: 18 }
        },
        {
          id: "jcp",
          name: "日本共産党",
          short: "共産党",
          color: "#cc0000",
          description: "再分配強化と平和外交を重視。消費税減税・原発ゼロ・改憲反対の立場です。",
          highlights: [
            "消費税を直ちに5%、将来廃止",
            "原発ゼロを目標",
            "安保法制廃止・安保3文書撤回",
            "年金引き上げと格差是正"
          ],
          position: { economic: 80, social: -76 }
        },
        {
          id: "reiwa",
          name: "れいわ新選組",
          short: "れいわ",
          color: "#ed6ea0",
          description: "積極財政と直接支援を前面に出し、消費税廃止や原発廃止を主張しています。",
          highlights: [
            "消費税即時廃止",
            "原発即時廃止",
            "安保法制の見直し・平和外交重視",
            "社会保険料軽減と一律10万円給付"
          ],
          position: { economic: 72, social: -66 }
        },
        {
          id: "sdp",
          name: "社会民主党",
          short: "社民党",
          color: "#1e90ff",
          description: "脱原発・平和外交・福祉重視を掲げる政党です。改憲には反対の立場です。",
          highlights: [
            "消費税ゼロを目標",
            "脱原発",
            "安保法制廃止と憲法9条に基づく外交",
            "格差是正と社会保障の拡充"
          ],
          position: { economic: 76, social: -86 }
        },
        {
          id: "sanseito",
          name: "参政党",
          short: "参政党",
          color: "#ff6600",
          description: "積極財政と国民生活優先を打ち出し、創憲や大胆な子育て支援を主張しています。",
          highlights: [
            "消費税廃止",
            "創憲（新しい憲法の制定）を提唱",
            "国民の生活を守る政策優先と不動産取得規制強化",
            "子ども1人あたり月10万円級の教育給付"
          ],
          position: { economic: 24, social: 82 }
        },
        {
          id: "nhk",
          name: "NHK党",
          short: "NHK党",
          color: "#8b4513",
          description: "本データセット内で争点別の明示情報が限られるため、比較は公開情報ベースの参考値として表示します。",
          highlights: [
            "争点別の公約公開情報が限定的",
            "既存制度の透明化を重視する姿勢",
            "主要争点では候補者・時期で強調点が変動",
            "本診断では傾向値として表示"
          ],
          position: { economic: 12, social: 26 }
        }
      ];

      const reactions = [
        "いい質問ですね。次へ進みます。",
        "立場が少しずつ見えてきました。",
        "この争点は結果に強く反映されます。",
        "判断の軸がシャープになってきました。"
      ];

      const questions = [
        {
          id: "tax",
          issue: "消費税",
          title: "Q1 消費税",
          prompt: "消費税についてあなたの考えに最も近いのは？",
          explanation: "消費税は家計負担と社会保障財源の両方に直結するため、生活重視か財源重視かの立場が表れやすい争点です。",
          partyStances: {
            ldp: "飲食料品0%を検討加速",
            ishin: "社会保険料引き下げを優先",
            reform: "食料品消費税ゼロ（今秋から）",
            dpfp: "減税+社会保険料軽減",
            jcp: "直ちに5%、将来廃止",
            reiwa: "即時廃止",
            sdp: "消費税ゼロを目標",
            sanseito: "廃止",
            nhk: "本データでは明示的な税率方針情報が限定的"
          },
          options: [
            {
              id: "A",
              text: "食料品だけでも期間限定で減税すべき",
              scores: { ldp: 3, ishin: 1, reform: 1, dpfp: 1, jcp: 0, reiwa: 0, sdp: 0, sanseito: 1, nhk: 1 }
            },
            {
              id: "B",
              text: "食料品は恒久的にゼロにすべき",
              scores: { ldp: 0, ishin: 0, reform: 3, dpfp: 1, jcp: 2, reiwa: 2, sdp: 2, sanseito: 1, nhk: 1 }
            },
            {
              id: "C",
              text: "消費税率自体を5%以下に引き下げるべき",
              scores: { ldp: 0, ishin: 0, reform: 1, dpfp: 1, jcp: 3, reiwa: 1, sdp: 1, sanseito: 2, nhk: 1 }
            },
            {
              id: "D",
              text: "消費税は廃止すべき",
              scores: { ldp: 0, ishin: 0, reform: 1, dpfp: 0, jcp: 2, reiwa: 3, sdp: 3, sanseito: 2, nhk: 1 }
            },
            {
              id: "E",
              text: "消費税より社会保険料の軽減を優先すべき",
              scores: { ldp: 1, ishin: 3, reform: 2, dpfp: 3, jcp: 1, reiwa: 1, sdp: 1, sanseito: 1, nhk: 1 }
            }
          ]
        },
        {
          id: "energy",
          issue: "原発・エネルギー",
          title: "Q2 原発・エネルギー",
          prompt: "日本のエネルギー政策について",
          explanation: "原発政策は電力安定供給・コスト・安全性・脱炭素の優先順位を問う争点で、長期の国家戦略に影響します。",
          partyStances: {
            ldp: "原発再稼働・活用推進",
            ishin: "条件付き容認",
            reform: "安全確認された原発の再稼働、原発依存低減",
            dpfp: "現実的な安定供給を重視",
            jcp: "原発ゼロを目標",
            reiwa: "原発即時廃止",
            sdp: "脱原発",
            sanseito: "段階的見直しを含む慎重姿勢",
            nhk: "本データでは詳細方針の公開情報が限定的"
          },
          options: [
            {
              id: "A",
              text: "原発を積極的に活用し、エネルギー安全保障を強化すべき",
              scores: { ldp: 3, ishin: 2, reform: 1, dpfp: 2, jcp: 0, reiwa: 0, sdp: 0, sanseito: 1, nhk: 1 }
            },
            {
              id: "B",
              text: "安全が確認された原発は再稼働しつつ、依存度は下げていくべき",
              scores: { ldp: 2, ishin: 3, reform: 3, dpfp: 2, jcp: 0, reiwa: 0, sdp: 0, sanseito: 1, nhk: 1 }
            },
            {
              id: "C",
              text: "原発は段階的に減らし、再エネに転換すべき",
              scores: { ldp: 0, ishin: 1, reform: 2, dpfp: 1, jcp: 2, reiwa: 1, sdp: 2, sanseito: 1, nhk: 1 }
            },
            {
              id: "D",
              text: "原発は即時停止・廃止すべき",
              scores: { ldp: 0, ishin: 0, reform: 0, dpfp: 0, jcp: 3, reiwa: 3, sdp: 3, sanseito: 0, nhk: 1 }
            }
          ]
        },
        {
          id: "security",
          issue: "安全保障・防衛",
          title: "Q3 安全保障",
          prompt: "日本の安全保障政策について",
          explanation: "安全保障は抑止力の強化と外交重視のバランスをどう取るかで、政党間の差が最も大きく出るテーマの一つです。",
          partyStances: {
            ldp: "安保3文書改定、防衛装備品輸出拡大",
            ishin: "安保3文書前倒し改定、核共有議論開始",
            reform: "防衛装備移転に慎重、非核三原則堅持",
            dpfp: "日米安保基軸の抑止力強化",
            jcp: "安保法制廃止・安保3文書撤回",
            reiwa: "安保法制見直し・平和外交重視",
            sdp: "安保法制廃止、憲法9条に基づく平和外交",
            sanseito: "安全保障強化に前向き",
            nhk: "本データでは詳細方針の公開情報が限定的"
          },
          options: [
            {
              id: "A",
              text: "防衛力を大幅強化し、装備品輸出も拡大すべき",
              scores: { ldp: 3, ishin: 2, reform: 0, dpfp: 2, jcp: 0, reiwa: 0, sdp: 0, sanseito: 2, nhk: 1 }
            },
            {
              id: "B",
              text: "核共有も含めた抑止力の議論を始めるべき",
              scores: { ldp: 2, ishin: 3, reform: 0, dpfp: 2, jcp: 0, reiwa: 0, sdp: 0, sanseito: 2, nhk: 1 }
            },
            {
              id: "C",
              text: "日米同盟を基軸に、現実的な防衛力を維持すべき",
              scores: { ldp: 2, ishin: 2, reform: 1, dpfp: 3, jcp: 0, reiwa: 0, sdp: 0, sanseito: 1, nhk: 1 }
            },
            {
              id: "D",
              text: "武器輸出には歯止めをかけ、外交重視で",
              scores: { ldp: 0, ishin: 0, reform: 3, dpfp: 1, jcp: 2, reiwa: 2, sdp: 2, sanseito: 0, nhk: 1 }
            },
            {
              id: "E",
              text: "安保法制を見直し、平和外交を基本とすべき",
              scores: { ldp: 0, ishin: 0, reform: 2, dpfp: 0, jcp: 3, reiwa: 3, sdp: 3, sanseito: 0, nhk: 1 }
            }
          ]
        },
        {
          id: "constitution",
          issue: "憲法改正",
          title: "Q4 憲法改正",
          prompt: "憲法改正について",
          explanation: "憲法改正は安全保障・統治制度・権利保障をどう設計するかに関わるため、国家像そのものを反映します。",
          partyStances: {
            ldp: "自衛隊明記のための改正推進",
            ishin: "改憲に前向き",
            reform: "慎重姿勢",
            dpfp: "議論には参加",
            jcp: "改憲反対",
            reiwa: "改憲反対",
            sdp: "改憲反対",
            sanseito: "創憲（新しい憲法の制定）を提唱",
            nhk: "本データでは詳細方針の公開情報が限定的"
          },
          options: [
            {
              id: "A",
              text: "自衛隊を明記する改正を進めるべき",
              scores: { ldp: 3, ishin: 2, reform: 0, dpfp: 1, jcp: 0, reiwa: 0, sdp: 0, sanseito: 3, nhk: 1 }
            },
            {
              id: "B",
              text: "時代に合わせた改正は必要だが、慎重に議論すべき",
              scores: { ldp: 1, ishin: 2, reform: 3, dpfp: 3, jcp: 1, reiwa: 1, sdp: 1, sanseito: 1, nhk: 1 }
            },
            {
              id: "C",
              text: "現行憲法を守り、改正には反対",
              scores: { ldp: 0, ishin: 0, reform: 2, dpfp: 1, jcp: 3, reiwa: 3, sdp: 3, sanseito: 0, nhk: 1 }
            }
          ]
        },
        {
          id: "social",
          issue: "社会保障・年金",
          title: "Q5 社会保障・年金",
          prompt: "社会保障制度について",
          explanation: "社会保障の議論は、財政の持続可能性と現役世代・高齢世代への再配分をどこまで行うかが中心になります。",
          partyStances: {
            ldp: "社会保障制度の持続可能性",
            ishin: "社会保険料引き下げ",
            reform: "ジャパン・ファンド創設、社会保険料負担低減",
            dpfp: "手取りを増やす（減税+社会保険料軽減）",
            jcp: "マクロ経済スライド廃止、年金引き上げ",
            reiwa: "社会保険料引き下げ、現金10万円一律給付",
            sdp: "福祉充実を重視",
            sanseito: "積極財政を背景に家計支援を重視",
            nhk: "本データでは詳細方針の公開情報が限定的"
          },
          options: [
            {
              id: "A",
              text: "制度の持続可能性を重視し、効率化を進めるべき",
              scores: { ldp: 3, ishin: 2, reform: 1, dpfp: 1, jcp: 0, reiwa: 0, sdp: 0, sanseito: 1, nhk: 1 }
            },
            {
              id: "B",
              text: "社会保険料を引き下げ、現役世代の負担を軽減すべき",
              scores: { ldp: 1, ishin: 3, reform: 3, dpfp: 3, jcp: 1, reiwa: 2, sdp: 1, sanseito: 1, nhk: 1 }
            },
            {
              id: "C",
              text: "年金給付を引き上げ、高齢者の生活を守るべき",
              scores: { ldp: 0, ishin: 0, reform: 1, dpfp: 0, jcp: 3, reiwa: 2, sdp: 2, sanseito: 0, nhk: 1 }
            },
            {
              id: "D",
              text: "現金給付など、直接的な支援を拡大すべき",
              scores: { ldp: 0, ishin: 0, reform: 1, dpfp: 1, jcp: 2, reiwa: 3, sdp: 2, sanseito: 2, nhk: 1 }
            }
          ]
        },
        {
          id: "childcare",
          issue: "少子化・子育て",
          title: "Q6 子育て・教育",
          prompt: "少子化対策・子育て支援について",
          explanation: "少子化対策は家計支援だけでなく、教育・住居・就労環境をどう組み合わせるかで政策効果が変わります。",
          partyStances: {
            ldp: "子育て環境の整備・支援強化",
            ishin: "現役世代負担軽減を通じた子育て支援",
            reform: "教育無償化拡大、家賃補助",
            dpfp: "手取り増を通じた家計支援",
            jcp: "家計支援と教育負担軽減を重視",
            reiwa: "直接給付を含む大胆支援",
            sdp: "子育て世帯への公的支援拡充",
            sanseito: "子供1人月10万円の教育給付金",
            nhk: "本データでは詳細方針の公開情報が限定的"
          },
          options: [
            {
              id: "A",
              text: "児童手当や教育無償化を着実に拡充すべき",
              scores: { ldp: 3, ishin: 1, reform: 3, dpfp: 2, jcp: 1, reiwa: 1, sdp: 1, sanseito: 1, nhk: 1 }
            },
            {
              id: "B",
              text: "子育て世帯への大胆な経済支援（月10万円級）が必要",
              scores: { ldp: 0, ishin: 0, reform: 1, dpfp: 1, jcp: 1, reiwa: 2, sdp: 1, sanseito: 3, nhk: 1 }
            },
            {
              id: "C",
              text: "若者への家賃補助など生活全般の支援が重要",
              scores: { ldp: 1, ishin: 1, reform: 3, dpfp: 2, jcp: 1, reiwa: 2, sdp: 1, sanseito: 1, nhk: 1 }
            },
            {
              id: "D",
              text: "教育の質向上と教員支援を優先すべき",
              scores: { ldp: 2, ishin: 2, reform: 2, dpfp: 2, jcp: 2, reiwa: 1, sdp: 2, sanseito: 1, nhk: 1 }
            }
          ]
        },
        {
          id: "foreign",
          issue: "外国人政策",
          title: "Q7 外国人・移民政策",
          prompt: "外国人政策について",
          explanation: "外国人政策は安全保障・人手不足・共生の課題が交差する領域で、社会観の違いが強く表れます。",
          partyStances: {
            ldp: "不動産取得規制、土地取得規制",
            ishin: "受け入れと規律の両立を重視",
            reform: "共生社会の実現",
            dpfp: "経済と社会のバランス重視",
            jcp: "人権と共生を重視",
            reiwa: "排除より生活支援と共生を重視",
            sdp: "多文化共生を重視",
            sanseito: "国民の生活を守る政策優先、不動産取得規制強化",
            nhk: "本データでは詳細方針の公開情報が限定的"
          },
          options: [
            {
              id: "A",
              text: "土地や不動産の取得を厳しく規制すべき",
              scores: { ldp: 3, ishin: 1, reform: 0, dpfp: 1, jcp: 0, reiwa: 0, sdp: 0, sanseito: 2, nhk: 1 }
            },
            {
              id: "B",
              text: "日本人を優先する政策を明確にすべき",
              scores: { ldp: 1, ishin: 1, reform: 0, dpfp: 1, jcp: 0, reiwa: 0, sdp: 0, sanseito: 3, nhk: 2 }
            },
            {
              id: "C",
              text: "外国人労働者の受け入れは経済のために必要",
              scores: { ldp: 2, ishin: 2, reform: 2, dpfp: 2, jcp: 1, reiwa: 1, sdp: 1, sanseito: 0, nhk: 1 }
            },
            {
              id: "D",
              text: "多文化共生社会の実現を目指すべき",
              scores: { ldp: 0, ishin: 1, reform: 3, dpfp: 1, jcp: 2, reiwa: 2, sdp: 2, sanseito: 0, nhk: 1 }
            }
          ]
        },
        {
          id: "economy",
          issue: "経済政策",
          title: "Q8 経済の方向性",
          prompt: "日本経済の立て直しに最も重要なことは？",
          explanation: "経済政策は成長優先か再分配優先かで大きく分かれ、税制・規制・財政出動の選択に直結します。",
          partyStances: {
            ldp: "成長投資、新たな予算枠",
            ishin: "規制改革、副首都構想",
            reform: "生活者ファースト",
            dpfp: "手取りを増やす",
            jcp: "大企業・富裕層への課税強化と再分配",
            reiwa: "積極財政、現金給付",
            sdp: "再分配と生活支援を重視",
            sanseito: "積極財政、GDP1000兆円",
            nhk: "本データでは詳細方針の公開情報が限定的"
          },
          options: [
            {
              id: "A",
              text: "成長投資と規制改革で経済を活性化",
              scores: { ldp: 3, ishin: 3, reform: 1, dpfp: 2, jcp: 0, reiwa: 0, sdp: 0, sanseito: 1, nhk: 1 }
            },
            {
              id: "B",
              text: "地方分権と副首都で東京一極集中を解消",
              scores: { ldp: 1, ishin: 3, reform: 1, dpfp: 1, jcp: 0, reiwa: 0, sdp: 0, sanseito: 2, nhk: 1 }
            },
            {
              id: "C",
              text: "生活者の手取りを増やすことが最優先",
              scores: { ldp: 1, ishin: 2, reform: 3, dpfp: 3, jcp: 1, reiwa: 1, sdp: 1, sanseito: 1, nhk: 1 }
            },
            {
              id: "D",
              text: "大企業・富裕層への課税を強化し再分配",
              scores: { ldp: 0, ishin: 0, reform: 1, dpfp: 0, jcp: 3, reiwa: 2, sdp: 3, sanseito: 0, nhk: 1 }
            },
            {
              id: "E",
              text: "積極的な財政出動で景気を刺激",
              scores: { ldp: 1, ishin: 0, reform: 1, dpfp: 1, jcp: 2, reiwa: 3, sdp: 2, sanseito: 3, nhk: 1 }
            }
          ]
        },
        {
          id: "reform_politics",
          issue: "政治改革",
          title: "Q9 政治改革",
          prompt: "政治とカネの問題について",
          explanation: "政治資金のルールは民主主義への信頼に直結します。規制と透明性をどう設計するかが核心です。",
          partyStances: {
            ldp: "透明性向上を軸に制度運用を改善",
            ishin: "既存制度の見直しとガバナンス強化",
            reform: "規制強化と透明性の両立を重視",
            dpfp: "透明化と実効性ある監督を重視",
            jcp: "企業・団体献金の全面禁止を主張",
            reiwa: "資金の透明化と規制強化を主張",
            sdp: "企業・団体献金の全面禁止を主張",
            sanseito: "政治資金の透明化強化を主張",
            nhk: "政治資金の徹底可視化を強調"
          },
          options: [
            {
              id: "A",
              text: "企業・団体献金は透明性を高めれば問題ない",
              scores: { ldp: 3, ishin: 2, reform: 1, dpfp: 2, jcp: 0, reiwa: 0, sdp: 0, sanseito: 1, nhk: 1 }
            },
            {
              id: "B",
              text: "企業・団体献金は規制を強化すべき",
              scores: { ldp: 1, ishin: 2, reform: 3, dpfp: 2, jcp: 2, reiwa: 2, sdp: 2, sanseito: 1, nhk: 1 }
            },
            {
              id: "C",
              text: "企業・団体献金は全面禁止すべき",
              scores: { ldp: 0, ishin: 1, reform: 2, dpfp: 1, jcp: 3, reiwa: 2, sdp: 3, sanseito: 1, nhk: 1 }
            },
            {
              id: "D",
              text: "政治資金そのものの大幅な透明化が必要",
              scores: { ldp: 1, ishin: 2, reform: 2, dpfp: 2, jcp: 2, reiwa: 2, sdp: 2, sanseito: 2, nhk: 3 }
            }
          ]
        },
        {
          id: "future",
          issue: "日本の将来像",
          title: "Q10 日本の将来像",
          prompt: "あなたが望む日本の将来像は？",
          explanation: "将来像の選択は、成長・安定・公平・伝統のどれを優先するかを示し、全体的な価値観の方向を反映します。",
          partyStances: {
            ldp: "経済大国・技術立国としてのプレゼンス強化",
            ishin: "成長と改革で競争力を高める",
            reform: "暮らしやすさと生活安定を重視",
            dpfp: "家計重視で現実的な成長を目指す",
            jcp: "格差是正と公正な社会を重視",
            reiwa: "誰も取り残さない再分配重視",
            sdp: "公正と尊厳を重視する社会を目指す",
            sanseito: "伝統と文化を守る国家像を重視",
            nhk: "既存制度の透明化と国民参加を重視"
          },
          options: [
            {
              id: "A",
              text: "経済大国・技術立国として国際的プレゼンスを高める",
              scores: { ldp: 3, ishin: 2, reform: 1, dpfp: 2, jcp: 0, reiwa: 0, sdp: 0, sanseito: 2, nhk: 1 }
            },
            {
              id: "B",
              text: "安全で豊かな生活を送れる「暮らしやすい国」",
              scores: { ldp: 2, ishin: 2, reform: 3, dpfp: 3, jcp: 1, reiwa: 1, sdp: 2, sanseito: 1, nhk: 1 }
            },
            {
              id: "C",
              text: "格差がなく誰もが尊重される「公正な社会」",
              scores: { ldp: 0, ishin: 0, reform: 2, dpfp: 1, jcp: 3, reiwa: 3, sdp: 3, sanseito: 0, nhk: 1 }
            },
            {
              id: "D",
              text: "伝統と文化を守り、日本らしさを大切にする国",
              scores: { ldp: 2, ishin: 1, reform: 0, dpfp: 1, jcp: 0, reiwa: 0, sdp: 0, sanseito: 3, nhk: 2 }
            }
          ]
        }
      ];

      // Load district data from JSON files
      async function loadDistrictData() {
        if (districtData) return districtData;

        const files = [
          'data-block-a.json',
          'data-block-b.json',
          'data-block-c.json',
          'data-block-d.json'
        ];

        const merged = {};

        for (const file of files) {
          const response = await fetch(file);
          const data = await response.json();
          Object.assign(merged, data.blocks);
        }

        districtData = merged;
        return districtData;
      }

      const maxScoresByParty = calculatePartyMaxScores();
      const state = {
        currentQuestion: 0,
        answers: [],
        result: null
      };

      const screens = {
        welcome: document.getElementById("welcomeScreen"),
        quiz: document.getElementById("quizScreen"),
        result: document.getElementById("resultScreen"),
        constituency: document.getElementById("constituencyScreen")
      };

      const startButton = document.getElementById("startButton");
      const selectConstituencyButton = document.getElementById("selectConstituencyButton");
      const progressText = document.getElementById("progressText");
      const progressPercent = document.getElementById("progressPercent");
      const progressFill = document.getElementById("progressFill");
      const questionCard = document.getElementById("questionCard");
      const reactionText = document.getElementById("reactionText");
      const summaryTab = document.getElementById("summaryTab");
      const learnTab = document.getElementById("learnTab");
      const tabButtons = Array.from(document.querySelectorAll(".tab-btn"));
      const confettiCanvas = document.getElementById("confetti");

      startButton.addEventListener("click", startQuiz);
      selectConstituencyButton.addEventListener("click", showConstituencySelection);

      tabButtons.forEach((button) => {
        button.addEventListener("click", () => switchTab(button.dataset.tab));
      });

      async function showConstituencySelection() {
        await loadDistrictData();
        switchScreen("constituency");
        renderPrefectureSelection();
      }

      function renderPrefectureSelection() {
        const regions = {
          "北海道・東北": ["北海道", "青森県", "岩手県", "宮城県", "秋田県", "山形県", "福島県"],
          "関東": ["茨城県", "栃木県", "群馬県", "埼玉県", "千葉県", "東京都", "神奈川県", "山梨県"],
          "中部": ["新潟県", "富山県", "石川県", "福井県", "長野県", "岐阜県", "静岡県", "愛知県", "三重県"],
          "近畿": ["滋賀県", "京都府", "大阪府", "兵庫県", "奈良県", "和歌山県"],
          "中国・四国": ["鳥取県", "島根県", "岡山県", "広島県", "山口県", "徳島県", "香川県", "愛媛県", "高知県"],
          "九州": ["福岡県", "佐賀県", "長崎県", "熊本県", "大分県", "宮崎県", "鹿児島県", "沖縄県"]
        };

        const html = Object.entries(regions).map(([region, prefs]) => `
          <div class="region-section">
            <h3 class="region-title">${region}</h3>
            <div class="prefecture-grid">
              ${prefs.map(pref => `
                <button class="prefecture-btn" data-prefecture="${pref}">${pref}</button>
              `).join("")}
            </div>
          </div>
        `).join("");

        document.getElementById("constituencyContent").innerHTML = `
          <button class="back-btn" id="backToWelcome">← 戻る</button>
          ${html}
        `;

        document.getElementById("backToWelcome").addEventListener("click", () => {
          switchScreen("welcome");
        });

        document.querySelectorAll(".prefecture-btn").forEach(btn => {
          btn.addEventListener("click", () => {
            const pref = btn.dataset.prefecture;
            renderDistrictSelection(pref);
          });
        });
      }

      function renderDistrictSelection(prefecture) {
        const blockName = prefectureToBlock[prefecture];
        const block = districtData[blockName];

        if (!block || !block.districts) {
          alert("この都道府県のデータが見つかりません");
          return;
        }

        const districts = Object.keys(block.districts).filter(d => d.includes(prefecture.replace(/[都道府県]/g, "")));

        const html = `
          <button class="back-btn" id="backToPrefecture">← 都道府県選択に戻る</button>
          <h3 class="section-title">${prefecture}の選挙区を選択</h3>
          <div class="district-grid">
            ${districts.map(district => `
              <button class="district-btn" data-district="${district}">${district}</button>
            `).join("")}
          </div>
        `;

        document.getElementById("constituencyContent").innerHTML = html;

        document.getElementById("backToPrefecture").addEventListener("click", renderPrefectureSelection);

        document.querySelectorAll(".district-btn").forEach(btn => {
          btn.addEventListener("click", () => {
            const district = btn.dataset.district;
            selectedConstituency = {
              prefecture,
              district,
              blockName,
              candidates: block.districts[district].candidates,
              proportionalParties: block.proportionalParties
            };
            startQuiz();
          });
        });
      }

      document.addEventListener("keydown", (event) => {
        if (!screens.quiz.classList.contains("active")) {
          return;
        }
        const q = questions[state.currentQuestion];
        if (!q) {
          return;
        }
        const num = Number(event.key);
        if (Number.isInteger(num) && num >= 1 && num <= q.options.length) {
          event.preventDefault();
          selectOption(q.options[num - 1].id);
        }
      });

      function calculatePartyMaxScores() {
        const maxScores = {};
        parties.forEach((party) => {
          maxScores[party.id] = 0;
        });
        questions.forEach((question) => {
          parties.forEach((party) => {
            const best = question.options.reduce((max, option) => {
              return Math.max(max, option.scores[party.id] ?? 0);
            }, 0);
            maxScores[party.id] += best;
          });
        });
        return maxScores;
      }

      function startQuiz() {
        state.currentQuestion = 0;
        state.answers = [];
        state.result = null;
        reactionText.textContent = "";
        reactionText.classList.remove("show");
        switchScreen("quiz");
        renderQuestion();
      }

      function switchScreen(name) {
        Object.entries(screens).forEach(([key, el]) => {
          el.classList.toggle("active", key === name);
        });
      }

      function renderQuestion() {
        const question = questions[state.currentQuestion];
        if (!question) {
          return;
        }

        const current = state.currentQuestion + 1;
        const percent = Math.round((current / questions.length) * 100);
        progressText.textContent = `${questions.length}問中 ${current}問目`;
        progressPercent.textContent = `${percent}%`;
        progressFill.style.width = `${percent}%`;

        const optionButtons = question.options.map((option, idx) => {
          return `
            <button class="option-btn" data-option-id="${option.id}" type="button" aria-label="${idx + 1}. ${option.text}">
              <span class="option-key">${option.id}</span>
              <span>${option.text}</span>
            </button>
          `;
        }).join("");

        questionCard.classList.remove("slide-in");
        questionCard.innerHTML = `
          <div class="question-top">
            <p class="question-badge">${question.title}</p>
            <p class="question-badge">キー操作: 1-${question.options.length}</p>
          </div>
          <h3 class="question-title">${question.prompt}</h3>
          <p class="question-hint">${question.explanation}</p>
          <div class="option-list">${optionButtons}</div>
        `;

        requestAnimationFrame(() => {
          questionCard.classList.add("slide-in");
        });

        Array.from(questionCard.querySelectorAll(".option-btn")).forEach((button) => {
          button.addEventListener("click", () => {
            selectOption(button.dataset.optionId);
          });
        });

        const firstBtn = questionCard.querySelector(".option-btn");
        if (firstBtn) {
          firstBtn.focus();
        }
      }

      function selectOption(optionId) {
        const question = questions[state.currentQuestion];
        if (!question) {
          return;
        }
        if (state.answers[state.currentQuestion]) {
          return;
        }

        const selectedOption = question.options.find((option) => option.id === optionId);
        if (!selectedOption) {
          return;
        }

        state.answers[state.currentQuestion] = selectedOption.id;
        const message = reactions[Math.floor(Math.random() * reactions.length)];
        reactionText.textContent = message;
        reactionText.classList.add("show");

        Array.from(questionCard.querySelectorAll(".option-btn")).forEach((btn) => {
          btn.disabled = true;
          if (btn.dataset.optionId === selectedOption.id) {
            btn.style.borderColor = "rgba(34, 197, 94, 0.85)";
            btn.style.background = "linear-gradient(180deg, rgba(22, 163, 74, 0.34), rgba(15, 23, 42, 0.86))";
          }
        });

        setTimeout(() => {
          reactionText.classList.remove("show");
          if (state.currentQuestion >= questions.length - 1) {
            showResults();
            return;
          }
          state.currentQuestion += 1;
          renderQuestion();
        }, 620);
      }

      function showResults() {
        state.result = calculateResults();
        renderSummary(state.result);
        renderLearningMode(state.result);
        switchTab("summary");
        switchScreen("result");
        runConfetti();
      }

      function calculateResults() {
        const rawScores = {};
        const matchedIssues = {};
        parties.forEach((party) => {
          rawScores[party.id] = 0;
          matchedIssues[party.id] = [];
        });

        questions.forEach((question, index) => {
          const answerId = state.answers[index];
          const selectedOption = question.options.find((option) => option.id === answerId);
          if (!selectedOption) {
            return;
          }
          parties.forEach((party) => {
            const points = selectedOption.scores[party.id] ?? 0;
            rawScores[party.id] += points;
            if (points >= 2) {
              matchedIssues[party.id].push({ issue: question.issue, points });
            }
          });
        });

        const ranked = parties.map((party) => {
          const maxScore = maxScoresByParty[party.id] || 1;
          const raw = rawScores[party.id];
          const percent = Math.round((raw / maxScore) * 100);
          const highlights = matchedIssues[party.id]
            .sort((a, b) => b.points - a.points)
            .slice(0, 3)
            .map((item) => item.issue);
          return {
            ...party,
            raw,
            maxScore,
            percent,
            matchIssues: highlights
          };
        }).sort((a, b) => {
          if (b.percent !== a.percent) {
            return b.percent - a.percent;
          }
          return b.raw - a.raw;
        });

        return {
          ranked,
          answers: questions.map((question, idx) => {
            const option = question.options.find((item) => item.id === state.answers[idx]);
            return {
              questionId: question.id,
              issue: question.issue,
              prompt: question.prompt,
              explanation: question.explanation,
              selectedOptionId: state.answers[idx],
              selectedText: option ? option.text : "未回答",
              partyStances: question.partyStances
            };
          })
        };
      }

      function renderSummary(result) {
        const top3 = result.ranked.slice(0, 3);

        summaryTab.innerHTML = `
          <div class="top3">
            ${top3.map((party, idx) => `
              <article class="party-card ${idx === 0 ? "rank-1" : ""}">
                <p class="party-rank">${idx + 1}位</p>
                <h3 class="party-name" style="color:${party.color};">${party.name}</h3>
                <p class="party-score">
                  <span class="countup" data-target="${party.percent}">0</span>%
                  <small>${party.raw} / ${party.maxScore}点</small>
                </p>
              </article>
            `).join("")}
          </div>

          <h3 class="section-title">全政党との一致率</h3>
          <div class="bars">
            ${result.ranked.map((party) => `
              <div class="bar-row">
                <span>${party.short}</span>
                <div class="bar-track">
                  <div class="bar-fill" data-fill-target="${party.percent}" style="background:${party.color};"></div>
                </div>
                <span class="bar-value"><span class="countup" data-target="${party.percent}">0</span>%</span>
              </div>
            `).join("")}
          </div>

          <section class="quick-learning">
            <p><strong>学びポイント:</strong> あなたの回答と各政党の政策比較を「学びモード」で確認できます。争点ごとの差が一目でわかります。</p>
          </section>

          ${selectedConstituency ? `
            <h3 class="section-title">あなたの選挙区の候補者</h3>
            <p style="color:#94a3b8;font-size:0.88rem;margin:8px 0 12px;">${selectedConstituency.district}</p>
            <div class="party-grid">
              ${selectedConstituency.candidates.map((candidate) => {
                const party = parties.find(p => p.id === candidate.partyId) || { color: "#94a3b8" };
                return `
                  <div class="candidate-card" style="border-left-color:${party.color};">
                    <h5>${candidate.name}</h5>
                    <p>${candidate.partyName}</p>
                  </div>
                `;
              }).join("")}
            </div>

            <h3 class="section-title">比例代表で投票できる政党（${selectedConstituency.blockName}ブロック）</h3>
            <div class="chip-row">
              ${selectedConstituency.proportionalParties.map((partyId) => {
                const party = parties.find(p => p.id === partyId);
                return party ? `<span class="chip" style="background:${party.color}22;border-color:${party.color}55;color:${party.color};">${party.short}</span>` : '';
              }).join("")}
            </div>
          ` : ''}

          <h3 class="section-title">政党別サマリー</h3>
          <div class="party-grid">
            ${result.ranked.map((party) => {
              const issues = party.matchIssues.length ? party.matchIssues : ["関連度が分散しました"];
              const hasCandidate = selectedConstituency && selectedConstituency.candidates.some(c => c.partyId === party.id);
              return `
                <article class="party-detail">
                  <h4 style="color:${party.color};">
                    ${party.name}
                    ${hasCandidate ? '<span class="candidate-badge">候補者あり</span>' : ''}
                    <span style="font-size:0.8rem;color:#cbd5e1;">(${party.percent}%)</span>
                  </h4>
                  <p>${party.description}</p>
                  <div class="chip-row">
                    ${issues.map((issue) => `<span class="chip">${issue}</span>`).join("")}
                  </div>
                </article>
              `;
            }).join("")}
          </div>

          <div class="actions">
            <button id="shareButton" class="btn btn-primary" type="button">結果をシェア</button>
            <button id="restartButton" class="btn btn-secondary" type="button">もう一度診断する</button>
          </div>

          <div class="disclaimer">
            この結果は政策の一致度の参考です。候補者の人柄や地域の事情も考慮してお選びください。<br>
            一致率は各政党の争点ごとの理論最大点に対する割合で算出しています。
          </div>
        `;

        const restartButton = document.getElementById("restartButton");
        const shareButton = document.getElementById("shareButton");
        if (restartButton) {
          restartButton.addEventListener("click", () => {
            selectedConstituency = null;
            switchScreen("welcome");
            window.scrollTo({ top: 0, behavior: "smooth" });
          });
        }
        if (shareButton) {
          shareButton.addEventListener("click", () => {
            shareResult(result);
          });
        }

        animatePercentages();
      }

      function renderLearningMode(result) {
        const answersCards = result.answers.map((answer) => {
          const stanceItems = parties.map((party) => {
            const stance = answer.partyStances[party.id] || "本データセットでの明示情報なし";
            return `<li class="stance-item"><strong style="color:${party.color};">${party.short}</strong>: ${stance}</li>`;
          }).join("");

          return `
            <article class="learn-card">
              <h4>${answer.issue} | ${answer.prompt}</h4>
              <p>${answer.explanation}</p>
              <p class="learn-answer">あなたの回答: ${answer.selectedOptionId}. ${answer.selectedText}</p>
              <details>
                <summary>各政党のスタンスを表示</summary>
                <ul class="stance-list">${stanceItems}</ul>
              </details>
            </article>
          `;
        }).join("");

        const positionDots = parties.map((party) => {
          const left = ((party.position.economic + 100) / 200) * 100;
          const top = (1 - ((party.position.social + 100) / 200)) * 100;
          return `
            <div class="dot" style="left:${left}%; top:${top}%; background:${party.color};" title="${party.name}"></div>
            <div class="dot-label" style="left:${left}%; top:${top}%;">${party.short}</div>
          `;
        }).join("");

        const manifestCards = parties.map((party) => `
          <article class="manifest-card">
            <h5 style="color:${party.color};">${party.name}</h5>
            <ul>
              ${party.highlights.slice(0, 4).map((point) => `<li>${point}</li>`).join("")}
            </ul>
          </article>
        `).join("");

        learnTab.innerHTML = `
          <section class="learn-block">
            <h3 class="section-title">争点別の学びポイント</h3>
            ${answersCards}

            <h3 class="section-title">政党ポジションマップ</h3>
            <div class="position-map-wrap">
              <div class="position-map" aria-label="政党ポジションマップ">
                <div class="axis-h"></div>
                <div class="axis-v"></div>
                <span class="axis-label" style="left:6px; top:6px;">社会: 保守</span>
                <span class="axis-label" style="left:6px; bottom:6px;">社会: リベラル</span>
                <span class="axis-label" style="left:6px; top:50%; transform:translateY(-50%);">経済: 自由市場</span>
                <span class="axis-label" style="right:6px; top:50%; transform:translateY(-50%);">経済: 再分配</span>
                ${positionDots}
              </div>
            </div>

            <h3 class="section-title">各政党の公約ハイライト</h3>
            <div class="manifest-grid">
              ${manifestCards}
            </div>
          </section>
        `;
      }

      function animatePercentages() {
        const countTargets = Array.from(document.querySelectorAll(".countup"));
        countTargets.forEach((el) => {
          const target = Number(el.dataset.target) || 0;
          animateNumber(el, target, 950);
        });

        const barTargets = Array.from(document.querySelectorAll(".bar-fill"));
        requestAnimationFrame(() => {
          barTargets.forEach((el) => {
            const target = Number(el.dataset.fillTarget) || 0;
            el.style.width = `${target}%`;
          });
        });
      }

      function animateNumber(node, target, duration) {
        const start = performance.now();
        const from = 0;
        function frame(now) {
          const elapsed = now - start;
          const ratio = Math.min(elapsed / duration, 1);
          const eased = 1 - Math.pow(1 - ratio, 3);
          const value = Math.round(from + (target - from) * eased);
          node.textContent = String(value);
          if (ratio < 1) {
            requestAnimationFrame(frame);
          }
        }
        requestAnimationFrame(frame);
      }

      function switchTab(tabName) {
        const isSummary = tabName === "summary";
        summaryTab.classList.toggle("active", isSummary);
        learnTab.classList.toggle("active", !isSummary);
        tabButtons.forEach((button) => {
          const active = button.dataset.tab === tabName;
          button.classList.toggle("active", active);
          button.setAttribute("aria-selected", active ? "true" : "false");
        });
      }

      async function shareResult(result) {
        const top = result.ranked[0];
        const text = [
          "【衆議院選挙2026 投票先診断】",
          `私の結果は 1位: ${top.name}（一致率 ${top.percent}%）`,
          "あなたも10問で政策スタンスをチェックしよう。",
          "#あなたの一票どこへ #衆議院選挙2026"
        ].join("\n");

        if (navigator.share) {
          try {
            await navigator.share({ text, title: "投票先診断結果" });
            return;
          } catch (error) {
            // Web Share API がキャンセルされた場合はクリップボードへフォールバック
          }
        }

        if (navigator.clipboard && navigator.clipboard.writeText) {
          try {
            await navigator.clipboard.writeText(text);
            alert("結果テキストをクリップボードにコピーしました。");
            return;
          } catch (error) {
            // 後続の fallback を利用
          }
        }

        window.prompt("このテキストをコピーしてシェアしてください。", text);
      }

      function runConfetti() {
        if (window.matchMedia("(prefers-reduced-motion: reduce)").matches) {
          return;
        }

        const ctx = confettiCanvas.getContext("2d");
        if (!ctx) {
          return;
        }

        const width = confettiCanvas.width = window.innerWidth;
        const height = confettiCanvas.height = window.innerHeight;
        const palette = parties.map((party) => party.color).concat(["#f8fafc", "#38bdf8"]);
        const particles = Array.from({ length: 120 }, () => ({
          x: Math.random() * width,
          y: -20 - Math.random() * height * 0.5,
          w: 5 + Math.random() * 7,
          h: 8 + Math.random() * 12,
          speedY: 1.8 + Math.random() * 3.2,
          speedX: -1.2 + Math.random() * 2.4,
          rotation: Math.random() * Math.PI * 2,
          rotSpeed: -0.15 + Math.random() * 0.3,
          color: palette[Math.floor(Math.random() * palette.length)]
        }));

        const duration = 2400;
        const start = performance.now();

        function draw(now) {
          const elapsed = now - start;
          ctx.clearRect(0, 0, width, height);

          particles.forEach((particle) => {
            particle.x += particle.speedX;
            particle.y += particle.speedY;
            particle.rotation += particle.rotSpeed;
            if (particle.y > height + 30) {
              particle.y = -20;
              particle.x = Math.random() * width;
            }
            ctx.save();
            ctx.translate(particle.x, particle.y);
            ctx.rotate(particle.rotation);
            ctx.fillStyle = particle.color;
            ctx.fillRect(-particle.w / 2, -particle.h / 2, particle.w, particle.h);
            ctx.restore();
          });

          if (elapsed < duration) {
            requestAnimationFrame(draw);
          } else {
            ctx.clearRect(0, 0, width, height);
          }
        }
        requestAnimationFrame(draw);
      }
    })();
  </script>
</body>
</html>
